# MathDesk 外部公開計画

## 目的
- ユーザーが通学中など外出先からアクセス可能にする
- 商業レベルのセキュリティでハッキング対策
- 無料枠内で運用

---

# 構成比較

## 構成A vs 構成B 早見表

| 項目 | 構成A（Firebase） | 構成B（Cloud Run統合） |
|------|------------------|----------------------|
| **ログイン方法** | Googleアカウント | 現在のアクセスコード維持 |
| **セキュリティ管理** | Google任せ（安心） | 自前管理（要対策） |
| **月額コスト** | 無料 | 無料〜月$10程度 |
| **コード変更量** | 大（認証+DB全面改修） | 中（セキュリティ強化のみ） |
| **実装難易度** | 高 | 中 |
| **作業日数目安** | 2-3日 | 1-2日 |
| **ユーザーの使い勝手** | Googleログイン（簡単） | コード入力（現状維持） |
| **将来の拡張性** | 高（Firebase連携豊富） | 中 |

## 推奨判断フロー

```
Googleアカウントでログインしてほしい？
  │
  ├─ Yes → 構成A（Firebase）
  │
  └─ No → 現在の「アクセスコード」で十分？
            │
            ├─ Yes → 構成B（Cloud Run統合）
            │
            └─ No → 構成A（メール/パスワード認証も可能）
```

---

# 構成A: Firebase 構成（セキュリティ重視）

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        Internet                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Firebase Hosting (CDN)                     │
│                   - React SPA配信                            │
│                   - 無料枠: 10GB/360MB日                     │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌──────────────────────┐         ┌──────────────────────────┐
│   Firebase Auth      │         │      Cloud Run           │
│   - Google認証       │ ──────► │   - Express API          │
│   - 無料枠: 10K/月   │  JWT検証 │   - 無料枠: 200万req/月  │
└──────────────────────┘         └──────────────────────────┘
                                              │
                                              ▼
                                 ┌──────────────────────────┐
                                 │      Firestore           │
                                 │   - ユーザーデータ       │
                                 │   - 学習履歴             │
                                 │   - 無料枠: 1GB/50K読取日│
                                 └──────────────────────────┘
```

## 無料枠の範囲

| サービス | 無料枠 | 家族利用での見込み |
|----------|--------|-------------------|
| Firebase Auth | 10,000認証/月 | 十分（数人） |
| Cloud Run | 200万リクエスト/月 | 十分 |
| Cloud Run | 36万vCPU秒/月 | 十分 |
| Firestore | 1GB保存 | 十分 |
| Firestore | 50,000読取/日 | 十分 |
| Firebase Hosting | 10GB保存, 360MB/日転送 | 十分 |

## セキュリティ対策

### 1. 認証（Firebase Auth）
- **Googleが管理**: パスワード漏洩、ブルートフォース対策はGoogle任せ
- **Google認証推奨**: パスワード管理不要で最も安全
- **JWT自動検証**: Firebase SDK が自動でトークン検証

### 2. バックエンド保護
- **Cloud Run認証**: Firebase IDトークン必須
- **CORS設定**: 許可ドメインのみアクセス可
- **HTTPS強制**: Cloud Run/Firebase Hostingは自動HTTPS

### 3. データベース保護
- **Firestoreセキュリティルール**: 認証ユーザーのみアクセス可
- **ユーザー分離**: 自分のデータのみ読み書き可能

### 4. 追加対策
- **レート制限**: Cloud Armor または Express middleware
- **ログ監視**: Cloud Logging で不審アクセス検知

## 実装フェーズ

### Phase 1: Firebase プロジェクト設定（1-2時間）
- [ ] Firebase プロジェクト作成
- [ ] Firebase Authentication 有効化（Google認証）
- [ ] Firestore データベース作成
- [ ] Firebase Hosting 設定

### Phase 2: 認証システム移行（3-4時間）
- [ ] フロントエンド: Firebase SDK 導入
- [ ] ログイン画面を Firebase UI に置き換え
- [ ] バックエンド: Firebase Admin SDK 導入
- [ ] JWT検証ミドルウェア実装
- [ ] 既存のアクセスコード認証を廃止または併用

### Phase 3: データベース移行（4-6時間）
- [ ] Firestore スキーマ設計
- [ ] SQLite → Firestore マイグレーションスクリプト
- [ ] バックエンドの DB 操作を Firestore に変更
- [ ] 動作確認・テスト

### Phase 4: デプロイ設定（2-3時間）
- [ ] Dockerfile 作成（バックエンド）
- [ ] Cloud Run デプロイ設定
- [ ] Firebase Hosting デプロイ設定
- [ ] 環境変数設定（本番用）

### Phase 5: 本番デプロイ・検証（1-2時間）
- [ ] Cloud Run デプロイ
- [ ] Firebase Hosting デプロイ
- [ ] 動作確認（PC/スマホ）
- [ ] セキュリティ確認

## 必要なGCPリソース

1. **Firebase プロジェクト**（GCPプロジェクトと連携）
2. **Cloud Run サービス**（APIサーバー）
3. **Firestore**（データベース）
4. **Firebase Hosting**（フロントエンド配信）

## 注意事項

- GCPアカウントに請求先設定が必要（無料枠のみでも）
- 無料枠超過時は自動課金されるため、予算アラート設定推奨
- 初期は東京リージョン（asia-northeast1）を使用

---

# 構成B: Cloud Run 統合構成（シンプル版）

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        Internet                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Cloud Run                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                Express Server                        │    │
│  │  - React SPA 配信（静的ファイル）                    │    │
│  │  - API エンドポイント                                │    │
│  │  - 認証ミドルウェア（強化版）                        │    │
│  │  - 無料枠: 200万req/月, 36万vCPU秒/月               │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                               │
│                              ▼                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              SQLite（永続ディスク）                  │    │
│  │  - 現在のスキーマをそのまま使用                      │    │
│  │  - Cloud Run ボリュームマウント                      │    │
│  │  - 無料枠内（ディスク1GB無料）                       │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

**代替**: SQLite → Cloud SQL (PostgreSQL) に移行する場合は月$10程度

## 無料枠の範囲

| サービス | 無料枠 | 家族利用での見込み |
|----------|--------|-------------------|
| Cloud Run | 200万リクエスト/月 | 十分 |
| Cloud Run | 36万vCPU秒/月 | 十分 |
| Cloud Run | 1GBメモリ | 十分 |
| 永続ディスク | 1GB（Cloud Run Gen2） | 十分 |
| Cloud Logging | 50GB/月 | 十分 |

## セキュリティ対策（自前実装）

### 1. 認証強化
現在の問題点と対策：

| 現在の実装 | リスク | 対策 |
|-----------|--------|------|
| localStorage にJWT保存 | XSS攻撃で盗難される | **httpOnly Cookie** に変更 |
| CSRF対策なし | 別サイトから不正リクエスト | **CSRFトークン** 導入 |
| ブルートフォース対策なし | アクセスコード総当たり | **レート制限** 導入 |
| 8文字コードのみ | 推測される可能性 | **試行回数制限 + IP制限** |

### 2. httpOnly Cookie 実装

```typescript
// 現在: localStorage
localStorage.setItem('token', jwt)

// 変更後: httpOnly Cookie
res.cookie('session', jwt, {
  httpOnly: true,      // JSからアクセス不可（XSS対策）
  secure: true,        // HTTPS必須
  sameSite: 'strict',  // CSRF対策
  maxAge: 7 * 24 * 60 * 60 * 1000  // 7日
})
```

### 3. CSRF 対策

```typescript
// リクエストごとにCSRFトークンを検証
app.use(csrfProtection)  // csurf ミドルウェア
```

### 4. レート制限

```typescript
import rateLimit from 'express-rate-limit'

// ログイン試行制限
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15分
  max: 5,                      // 最大5回
  message: 'ログイン試行回数が多すぎます。15分後にお試しください。'
})

// API全体の制限
const apiLimiter = rateLimit({
  windowMs: 60 * 1000,  // 1分
  max: 100              // 100リクエスト/分
})
```

### 5. アクセスコード強化オプション

```typescript
// オプション1: コード長を12文字に延長
const accessCode = generateAccessCode(12)  // 現在8文字

// オプション2: 数字のみではなく英数字混合
const accessCode = generateAlphanumeric(8)

// オプション3: 失敗時のロックアウト
if (failedAttempts >= 5) {
  lockAccount(userId, 30 * 60 * 1000)  // 30分ロック
}
```

### 6. ネットワークセキュリティ

- **HTTPS強制**: Cloud Run は自動でHTTPS
- **CORS設定**: 許可ドメインのみ

```typescript
const corsOptions = {
  origin: 'https://your-domain.run.app',  // 本番ドメインのみ
  credentials: true  // Cookie送信許可
}
```

### 7. セキュリティヘッダー

```typescript
import helmet from 'helmet'

app.use(helmet())  // 以下を自動設定
// - Content-Security-Policy
// - X-Content-Type-Options
// - X-Frame-Options
// - etc.
```

## 実装フェーズ

### Phase 1: セキュリティ強化（2-3時間）
- [ ] express-rate-limit 導入（ブルートフォース対策）
- [ ] helmet 導入（セキュリティヘッダー）
- [ ] CORS 設定強化
- [ ] localStorage → httpOnly Cookie 移行
- [ ] CSRF トークン実装

### Phase 2: デプロイ準備（2-3時間）
- [ ] Dockerfile 作成
- [ ] フロントエンドビルドをExpressで配信設定
- [ ] 環境変数設定（本番用）
- [ ] Cloud Run 用の設定ファイル作成

### Phase 3: 永続化対応（1-2時間）
- [ ] Cloud Run Gen2 ボリューム設定
- [ ] SQLite ファイルパスを環境変数化
- [ ] バックアップスクリプト作成

### Phase 4: 本番デプロイ・検証（1-2時間）
- [ ] Cloud Run デプロイ
- [ ] 動作確認（PC/スマホ）
- [ ] セキュリティテスト（レート制限等）
- [ ] 予算アラート設定

## 必要なGCPリソース

1. **Cloud Run サービス**（API + フロントエンド配信）
2. **永続ディスク**（SQLite保存用、オプション）
3. **Cloud Logging**（ログ監視）

## メリット・デメリット

### メリット
- **コード変更が少ない**: 認証ロジックは維持、セキュリティ層を追加するだけ
- **学習コスト低**: Firebase/Firestoreの学習不要
- **シンプル**: 1サービスで完結
- **現在のUXを維持**: アクセスコードでのログインそのまま

### デメリット
- **セキュリティは自己責任**: Firebase Authほどの堅牢性はない
- **SQLite制約**: 高負荷時は性能限界あり（家族利用なら問題なし）
- **スケーラビリティ制限**: 大量ユーザーには不向き

---

# 結論：どちらを選ぶべきか

## 構成A（Firebase）が向いている場合

- Googleアカウントでログインしてもらいたい
- セキュリティは専門家（Google）に任せたい
- 将来的に機能拡張（プッシュ通知等）を考えている
- データベース設計を見直す良い機会と考える

## 構成B（Cloud Run統合）が向いている場合

- 現在のアクセスコード方式を気に入っている
- なるべく早く外部公開したい
- コード変更を最小限にしたい
- Firebaseの学習コストを避けたい

## 家族利用での推奨

**ユーザーがGoogleアカウントを持っている** → **構成A**
- ログインが簡単（パスワード入力不要）
- セキュリティは最強レベル

**アクセスコードの方がシンプルで良い** → **構成B**
- 「このコードを入れてね」で済む
- 実装も早い

---

## 次のステップ

どちらの構成にするか決まったら、詳細な実装に進みます。
